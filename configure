#/bin/sh
# This configure script written by Brian Callahan <bcallah@devio.us>
# and released into the Public Domain.

printf "Checking for a program named yacc... "
cat << EOF > /tmp/oyaccconfig.y
%{
/* This is a test.  */
%}

%%

yacctest:	'='
	;

%%

int
main(void)
{
	return 0;
}
EOF
yacc -o /dev/null /tmp/oyaccconfig.y > /dev/null 2>&1

if [ $? -eq 0 ] ; then
echo "found"
yaccoroyacc=oyacc
fix=oyyfix
else
echo "not found"
yaccoroyacc=yacc
fix=yyfix
fi

rm -f /tmp/oyaccconfig.y

echo "Program will be installed as $yaccoroyacc."
echo "Now type 'make' to build."

cc="cc"

os=`uname -s`
if [ "x$os" = "xOpenBSD" ] ; then
  cflags="-O2 -pipe -Wall"
elif [ "x$os" = "xBitrig" ] ; then
  cflags="-O2 -pipe -Wall"
elif [ "x$os" = "xFreeBSD" ] ; then
  cflags="-O2 -pipe -Wall -D__dead=\"__dead2\""
  objs="portable/reallocarray.o"
elif [ "x$os" = "xNetBSD" ] ; then
  cflags="-O2 -pipe -Wall"
  objs="portable/reallocarray.o"
elif [ "x$os" = "xDragonFly" ] ; then
  cflags="-O2 -pipe -Wall -D__dead=\"__dead2\""
elif [ "x$os" = "xDarwin" ] ; then
  cflags="-O2 -pipe -Wall -D__dead=\"__attribute__((__noreturn__))\""
  objs="portable/reallocarray.o"
elif [ "x$os" = "xLinux" ] ; then
  cc="gcc"
  cflags="-O2 -pipe -Wall -D__dead=\"__attribute__((__noreturn__))\""
  objs="portable/reallocarray.o portable/strlcpy.o"
elif [ "x$os" = "xSunOS" ] ; then
  cflags="-xO2 -D__dead=\"\""
  objs="portable/asprintf.o portable/reallocarray.o"
elif [ "x$os" = "xAIX" ] ; then
  cflags="-O3 -qstrict -qro -qroconst -D__dead=\"\""
  objs="portable/asprintf.o portable/reallocarray.o portable/strlcpy.o"
else
  os=`uname -s | cut -c 1-6`
  if [ "x$os" = "xCYGWIN" ] ; then
    cflags="-O2 -Wall -D_GNU_SOURCE -D__dead=\"__attribute__((__noreturn__))\""
    objs="portable/reallocarray.o"
  else
    echo "Unknown operating system, please add the OS to this script"
    echo "and submit a pull request to https://github.com/ibara/yacc"
    exit 1
  fi
fi

cat << EOF > Makefile
# This Makefile was generated by configure.

CC=	$cc
CFLAGS=	$cflags

PREFIX=	/usr/local
BINDIR=	\${PREFIX}/bin
MANDIR=	\${PREFIX}/man/man1

PROG=	$yaccoroyacc
OBJS=	closure.o error.o lalr.o lr0.o main.o mkpar.o output.o reader.o \\
	skeleton.o symtab.o verbose.o warshall.o \\
	$objs

all: \${OBJS}
	\${CC} \${LDFLAGS} -o \${PROG} \${OBJS}

install: all
	install -d \${DESTDIR}\${BINDIR}
	install -d \${DESTDIR}\${MANDIR}
	install -m 555 yyfix.sh \${DESTDIR}\${BINDIR}/$fix
	install -m 555 \${PROG} \${DESTDIR}\${BINDIR}
	install -m 444 yacc.1 \${DESTDIR}\${MANDIR}/\${PROG}.1
	install -m 444 yyfix.1 \${DESTDIR}\${MANDIR}/$fix.1

test:
	echo "No tests"

clean:
	rm -f \${PROG} \${OBJS}

distclean: clean
	rm -f Makefile
EOF
